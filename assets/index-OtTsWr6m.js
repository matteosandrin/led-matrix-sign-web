(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))n(i);new MutationObserver(i=>{for(const o of i)if(o.type==="childList")for(const s of o.addedNodes)s.tagName==="LINK"&&s.rel==="modulepreload"&&n(s)}).observe(document,{childList:!0,subtree:!0});function e(i){const o={};return i.integrity&&(o.integrity=i.integrity),i.referrerPolicy&&(o.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?o.credentials="include":i.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function n(i){if(i.ep)return;i.ep=!0;const o=e(i);fetch(i.href,o)}})();const x={WEEKDAY:"weekday",SATURDAY:"saturday",SUNDAY:"sunday"},h=160,f=32,S=4,R="#D0FF00",y="#E28522",v="#000000",E={1:"#EE0900",2:"#EE0900",3:"#EE0900",4:"#3CBE3C",5:"#3CBE3C",6:"#3CBE3C",7:"#B200A2",A:"#33BBFF",C:"#33BBFF",E:"#33BBFF",G:"#AED92B",B:"#FF6800",D:"#FF6800",F:"#FF6800",M:"#FF6800",J:"#B37F2D",Z:"#B37F2D",L:"#898888",GS:"#545661",N:"#FCBB0A",Q:"#FCBB0A",R:"#FCBB0A",W:"#FCBB0A",SI:"#33BBFF"},A=6,_=5e3,T=10,w="MTASans",D=[15,31],m=16,I={center:"ctr",Center:"Ctr",junction:"jct",Junction:"Jct"},F="A20";class b{historicalData=null;stations=[];childStationIds=new Set;lastSecondTrain=null;async loadData(){const e=await(await fetch("/historical-data.json")).json();this.historicalData=this.decompressHistoricalData(e);const n=await fetch("/stations.json");this.stations=await n.json(),this.buildChildStationSet()}decompressHistoricalData(t){const e={w:x.WEEKDAY,s:x.SATURDAY,u:x.SUNDAY},n={};for(const i in t.data)n[i]=t.data[i].map(o=>({route_id:o[0],direction_id:o[1],long_name:t.names[o[2]],departure_time:o[3],trip_id:"",day_type:e[o[4]]||o[4]}));return n}buildChildStationSet(){this.childStationIds.clear();for(const t of this.stations)if(t.children)for(const e of t.children)this.childStationIds.add(e)}getStations(){return this.stations.filter(t=>!this.childStationIds.has(t.stop_id))}getStation(t){return this.stations.find(e=>e.stop_id===t)}getPredictions(t,e=null){if(!this.historicalData)return[];const n=[t],i=this.getStation(t);i?.children&&n.push(...i.children);const o=new Date,s=this.getDayType(o),r=this.getSecondsFromMidnight(o),l=[];for(const c of n){const d=this.historicalData[c];if(d)for(const a of d){if(a.day_type!==s||e!==null&&a.direction_id!==e.toString())continue;let g=a.departure_time-r;if(g<0&&(g+=24*3600),g>3600||g<0)continue;const p=this.isExpressTrain(a.route_id,a.trip_id);l.push({route_id:a.route_id,direction_id:a.direction_id,long_name:a.long_name,time:g,display_order:0,trip_id:a.trip_id,is_express:p})}}return l.sort((c,d)=>c.time-d.time),l.forEach((c,d)=>{c.display_order=d}),l.slice(0,A)}getSecondTrain(t){if(!t||t.length<2)return null;if(this.lastSecondTrain===null)return this.lastSecondTrain=t[1],t[1];for(let e=0;e<t.length;e++)if(t[e].display_order===this.lastSecondTrain.display_order){let n=e+1;return n>=t.length&&(n=1),this.lastSecondTrain=t[n],t[n]}return this.lastSecondTrain=t[1],t[1]}getDayType(t){const e=t.getDay();return e===0?x.SUNDAY:e===6?x.SATURDAY:x.WEEKDAY}getSecondsFromMidnight(t){return t.getHours()*3600+t.getMinutes()*60+t.getSeconds()}isExpressTrain(t,e){return t!=="4"&&t!=="6"?!1:e.includes("_X")||e.includes("EXPRESS")}}class L{canvas;ctx;imageData;constructor(t){this.canvas=t;const e=t.getContext("2d",{willReadFrequently:!0});if(!e)throw new Error("Could not get 2D context");this.ctx=e,this.canvas.width=h,this.canvas.height=f,this.canvas.style.width=`${h*S}px`,this.canvas.style.height=`${f*S}px`,this.ctx.imageSmoothingEnabled=!1,this.imageData=this.ctx.createImageData(h,f),this.clear()}clear(){this.ctx.fillStyle=v,this.ctx.fillRect(0,0,h,f),this.imageData=this.ctx.getImageData(0,0,h,f)}getContext(){return this.ctx}setPixel(t,e,n){if(t<0||t>=h||e<0||e>=f)return;const i=this.hexToRgb(n),o=(e*h+t)*4;this.imageData.data[o]=i.r,this.imageData.data[o+1]=i.g,this.imageData.data[o+2]=i.b,this.imageData.data[o+3]=255}update(){this.ctx.putImageData(this.imageData,0,0)}sync(){this.imageData=this.ctx.getImageData(0,0,h,f)}hexToRgb(t){const e=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(t);return e?{r:parseInt(e[1],16),g:parseInt(e[2],16),b:parseInt(e[3],16)}:{r:0,g:0,b:0}}parseRgb(t){if(t.startsWith("#"))return this.hexToRgb(t);const e=t.match(/rgb\((\d+),\s*(\d+),\s*(\d+)\)/);return e?{r:parseInt(e[1]),g:parseInt(e[2]),b:parseInt(e[3])}:{r:0,g:0,b:0}}}class B{ctx;fontLoaded=!1;constructor(t){this.ctx=t}async waitForFont(){if(!this.fontLoaded)try{await document.fonts.load(`${T}px ${w}`),this.fontLoaded=!0}catch(t){console.warn("Font loading failed, using fallback",t),this.fontLoaded=!0}}drawText(t,e,n,i,o={}){const{align:s="left",baseline:r="bottom"}=o;return this.ctx.font=`${T}px ${w}, monospace`,this.ctx.fillStyle=i,this.ctx.textAlign=s,this.ctx.textBaseline=r,this.ctx.fillText(t,e,n),this.measureText(t)}measureText(t){return this.ctx.font=`${T}px ${w}, monospace`,this.ctx.measureText(t).width}truncateTextSmart(t,e){if(this.measureText(t)<=e)return t;if(t.includes("-")){const s=t.split("-")[0];if(this.measureText(s)<=e)return s}let n=t;for(const[o,s]of Object.entries(I))n=n.replace(o,s);if(this.measureText(n)<=e)return n;const i=n.split(" ");for(let o=i.length-1;o>0;o--){const s=i.slice(0,o).join(" ");if(this.measureText(s)<=e)return s}for(let o=n.length-1;o>0;o--){const s=n.substring(0,o);if(this.measureText(s)<=e)return s}return""}getTextDimensions(t){this.ctx.font=`${T}px ${w}, monospace`;const e=this.ctx.measureText(t);return{width:e.width,height:e.actualBoundingBoxAscent!==void 0?e.actualBoundingBoxAscent+e.actualBoundingBoxDescent:T}}}class P{iconCache=new Map;coloredIconCache=new Map;async loadIcon(t,e=!1){const n=this.getIconFilename(t,e),i=n;return this.iconCache.has(i)?this.iconCache.get(i):new Promise((o,s)=>{const r=new Image;r.onload=()=>{this.iconCache.set(i,r),o(r)},r.onerror=()=>{s(new Error(`Failed to load icon: ${n}`))},r.src=`/img/${n}`})}async getColoredIcon(t,e=!1){const n=E[t]||"#FFFFFF",i=`${t}_${e}_${n}`;if(this.coloredIconCache.has(i))return this.coloredIconCache.get(i);const o=await this.loadIcon(t,e),s=document.createElement("canvas");s.width=m,s.height=m;const r=s.getContext("2d",{willReadFrequently:!0});if(!r)throw new Error("Could not get 2D context for icon coloring");r.drawImage(o,0,0,m,m);const l=r.getImageData(0,0,m,m),c=l.data,d=this.hexToRgb(n);for(let a=0;a<c.length;a+=4){const p=c[a]/255;c[a]=Math.round(p*d.r),c[a+1]=Math.round(p*d.g),c[a+2]=Math.round(p*d.b)}return r.putImageData(l,0,0),this.coloredIconCache.set(i,s),s}async drawIcon(t,e,n,i,o=!1){const s=await this.getColoredIcon(e,o);t.drawImage(s,n,i,m,m)}getIconFilename(t,e){return e&&(t==="4"||t==="6")?`mta_${t}_express.png`:`mta_${t}.png`}hexToRgb(t){const e=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(t);return e?{r:parseInt(e[1],16),g:parseInt(e[2],16),b:parseInt(e[3],16)}:{r:0,g:0,b:0}}async preloadIcons(){const t=Object.keys(E),e=[];for(const n of t)e.push(this.loadIcon(n,!1)),(n==="4"||n==="6")&&e.push(this.loadIcon(n,!0));await Promise.all(e)}}class G{isRunning=!1;startTime=0;animationId=null;duration=15e3;fps=6;textTimeFraction=2/3;ctx;text;x;y;width;height;font;onComplete;onFrame;constructor(t,e,n,i,o,s,r,l,c){this.ctx=t,this.text=e,this.x=n,this.y=i,this.width=o,this.height=s,this.font=r,this.onComplete=l,this.onFrame=c}start(){this.isRunning||(this.isRunning=!0,this.startTime=Date.now(),this.animate())}stop(){this.isRunning=!1,this.animationId!==null&&(cancelAnimationFrame(this.animationId),this.animationId=null)}animate=()=>{if(!this.isRunning)return;const t=Date.now()-this.startTime;if(t>=this.duration){this.drawText(),this.isRunning=!1,this.onFrame&&this.onFrame(),this.onComplete();return}const e=1e3/this.fps,n=Math.floor(t%1e3/e),i=Math.floor(this.textTimeFraction*this.fps);n<i?this.drawText():this.drawBlank(),this.onFrame&&this.onFrame(),this.animationId=requestAnimationFrame(this.animate)};drawText(){this.ctx.font=this.font,this.ctx.fillStyle=y,this.ctx.textAlign="right",this.ctx.textBaseline="bottom",this.ctx.fillText(this.text,this.x+this.width,this.y+this.height-1)}drawBlank(){this.ctx.fillStyle="#000000",this.ctx.fillRect(this.x,this.y,this.width,this.height)}isActive(){return this.isRunning}}class M{canvasRenderer;textRenderer;imageRenderer;blinkAnimation=null;onAnimationFrame;constructor(t){this.canvasRenderer=new L(t),this.textRenderer=new B(this.canvasRenderer.getContext()),this.imageRenderer=new P}setAnimationFrameCallback(t){this.onAnimationFrame=t}async initialize(){await Promise.all([this.textRenderer.waitForFont(),this.imageRenderer.preloadIcons()])}async render(t){const e=this.canvasRenderer.getContext(),n=t.length>0&&t[0].time>20&&t[0].time<=30;this.canvasRenderer.clear();const i=Math.min(t.length,2);for(let o=0;o<i;o++)await this.renderTrainRow(t[o],o,e);this.canvasRenderer.sync(),n&&!this.blinkAnimation?.isActive()&&this.startBlinkAnimation(e)}async renderTrainRow(t,e,n){const i=D[e];let o=0;const s=Math.round(t.time/60),l=t.time<=30&&e===0?y:R,c=`${t.display_order+1}.`,d=this.textRenderer.drawText(c,o,i,l);o+=d,await this.imageRenderer.drawIcon(n,t.route_id,o,i-15,t.is_express),o+=m+1;const a=`${s}min`,g=this.textRenderer.measureText(a),p=h-o-g-1,C=this.textRenderer.truncateTextSmart(t.long_name,p);this.textRenderer.drawText(C,o,i,l),this.textRenderer.drawText(a,h,i,l,{align:"right"})}startBlinkAnimation(t){const e="0min",n=`${T}px ${w}, monospace`,i=this.textRenderer.measureText(e),o=h-i,s=D[0],r=16;this.blinkAnimation=new G(t,e,o,s-15,i,r,n,()=>{this.blinkAnimation=null},()=>{this.onAnimationFrame&&this.onAnimationFrame()}),this.blinkAnimation.start()}clear(){this.canvasRenderer.clear(),this.blinkAnimation?.isActive()&&(this.blinkAnimation.stop(),this.blinkAnimation=null)}}const U={ledSize:.85,glowIntensity:.3,glowRadius:1.5,separationGap:.15};class ${gl;program=null;sourceTexture=null;displayCanvas;sourceWidth;sourceHeight;locations={};params;constructor(t,e,n,i={}){this.displayCanvas=t,this.sourceWidth=e,this.sourceHeight=n,this.params={...U,...i};const o=t.getContext("webgl",{alpha:!1,antialias:!1,preserveDrawingBuffer:!1});if(!o)throw new Error("WebGL not supported");this.gl=o,this.initShaders(),this.initGeometry(),this.initTexture()}initShaders(){const t=this.gl,e=`
      attribute vec2 aPosition;
      attribute vec2 aTexCoord;
      varying vec2 vTexCoord;

      void main() {
        gl_Position = vec4(aPosition, 0.0, 1.0);
        vTexCoord = aTexCoord;
      }
    `,n=`
      precision mediump float;

      uniform sampler2D uSourceTexture;
      uniform vec2 uSourceSize;      // Source texture size (160x32)
      uniform vec2 uDisplaySize;     // Display size (640x128)
      uniform float uLEDSize;        // LED size relative to cell (0-1)
      uniform float uGlowIntensity;  // Glow strength
      uniform float uGlowRadius;     // Glow radius in source pixels
      uniform float uSeparationGap;  // Gap between LEDs (0-1)

      varying vec2 vTexCoord;

      // Calculate distance from point to nearest LED center
      float getDistanceToLED(vec2 sourceCoord) {
        vec2 ledCoord = sourceCoord * uSourceSize;
        vec2 ledCell = floor(ledCoord);
        vec2 ledCenter = ledCell + 0.5;
        vec2 delta = ledCoord - ledCenter;
        return length(delta);
      }

      // Smooth circle falloff for LED shape - very tight transition for sharp, HD appearance
      float ledShape(float dist, float radius) {
        // Use a very tight smoothstep for crisp, high-definition LEDs
        return smoothstep(radius + 0.05, radius - 0.05, dist);
      }

      // Gaussian blur approximation for glow
      vec3 sampleGlow(vec2 sourceCoord, float radius) {
        vec3 glow = vec3(0.0);
        float totalWeight = 0.0;

        // Sample in a cross pattern for performance
        int samples = 8;
        for (int i = -4; i <= 4; i++) {
          if (i == 0) continue;

          float offset = float(i) * 0.25;
          vec2 sampleCoord1 = sourceCoord + vec2(offset / uSourceSize.x, 0.0);
          vec2 sampleCoord2 = sourceCoord + vec2(0.0, offset / uSourceSize.y);

          float weight = exp(-abs(offset) / radius);

          glow += texture2D(uSourceTexture, sampleCoord1).rgb * weight;
          glow += texture2D(uSourceTexture, sampleCoord2).rgb * weight;
          totalWeight += weight * 2.0;
        }

        return glow / max(totalWeight, 0.001);
      }

      void main() {
        vec2 sourceCoord = vTexCoord;

        // Get distance from nearest LED center
        float distToLED = getDistanceToLED(sourceCoord);

        // Sample the source color at LED center
        vec2 ledCell = floor(sourceCoord * uSourceSize);
        vec2 ledCenterUV = (ledCell + 0.5) / uSourceSize;
        vec3 ledColor = texture2D(uSourceTexture, ledCenterUV).rgb;

        // LED base shape with separation gap
        float ledRadius = (0.5 - uSeparationGap * 0.5) * uLEDSize;
        float ledMask = ledShape(distToLED, ledRadius);

        // Apply LED color with shape mask
        vec3 color = ledColor * ledMask;

        // Add glow/bloom effect
        if (uGlowIntensity > 0.0) {
          vec3 glow = sampleGlow(sourceCoord, uGlowRadius);
          float brightness = dot(glow, vec3(0.299, 0.587, 0.114));
          color += glow * uGlowIntensity * brightness;
        }

        gl_FragColor = vec4(color, 1.0);
      }
    `,i=this.compileShader(t.VERTEX_SHADER,e),o=this.compileShader(t.FRAGMENT_SHADER,n),s=t.createProgram();if(!s)throw new Error("Failed to create program");if(t.attachShader(s,i),t.attachShader(s,o),t.linkProgram(s),!t.getProgramParameter(s,t.LINK_STATUS)){const r=t.getProgramInfoLog(s);throw new Error("Failed to link program: "+r)}this.program=s,t.useProgram(s),this.locations={position:t.getAttribLocation(s,"aPosition"),texCoord:t.getAttribLocation(s,"aTexCoord"),uSourceTexture:t.getUniformLocation(s,"uSourceTexture"),uSourceSize:t.getUniformLocation(s,"uSourceSize"),uDisplaySize:t.getUniformLocation(s,"uDisplaySize"),uLEDSize:t.getUniformLocation(s,"uLEDSize"),uGlowIntensity:t.getUniformLocation(s,"uGlowIntensity"),uGlowRadius:t.getUniformLocation(s,"uGlowRadius"),uSeparationGap:t.getUniformLocation(s,"uSeparationGap")}}compileShader(t,e){const n=this.gl,i=n.createShader(t);if(!i)throw new Error("Failed to create shader");if(n.shaderSource(i,e),n.compileShader(i),!n.getShaderParameter(i,n.COMPILE_STATUS)){const o=n.getShaderInfoLog(i);throw n.deleteShader(i),new Error("Failed to compile shader: "+o)}return i}initGeometry(){const t=this.gl,e=new Float32Array([-1,-1,0,1,1,-1,1,1,-1,1,0,0,1,1,1,0]),n=t.createBuffer();t.bindBuffer(t.ARRAY_BUFFER,n),t.bufferData(t.ARRAY_BUFFER,e,t.STATIC_DRAW);const i=4*Float32Array.BYTES_PER_ELEMENT;this.locations.position!==void 0&&(t.enableVertexAttribArray(this.locations.position),t.vertexAttribPointer(this.locations.position,2,t.FLOAT,!1,i,0)),this.locations.texCoord!==void 0&&(t.enableVertexAttribArray(this.locations.texCoord),t.vertexAttribPointer(this.locations.texCoord,2,t.FLOAT,!1,i,2*Float32Array.BYTES_PER_ELEMENT))}initTexture(){const t=this.gl,e=t.createTexture();if(!e)throw new Error("Failed to create texture");t.bindTexture(t.TEXTURE_2D,e),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),this.sourceTexture=e}setParams(t){this.params={...this.params,...t}}render(t){const e=this.gl;!this.program||!this.sourceTexture||(e.bindTexture(e.TEXTURE_2D,this.sourceTexture),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,t),e.uniform1i(this.locations.uSourceTexture,0),e.uniform2f(this.locations.uSourceSize,this.sourceWidth,this.sourceHeight),e.uniform2f(this.locations.uDisplaySize,this.displayCanvas.width,this.displayCanvas.height),e.uniform1f(this.locations.uLEDSize,this.params.ledSize),e.uniform1f(this.locations.uGlowIntensity,this.params.glowIntensity),e.uniform1f(this.locations.uGlowRadius,this.params.glowRadius),e.uniform1f(this.locations.uSeparationGap,this.params.separationGap),e.viewport(0,0,this.displayCanvas.width,this.displayCanvas.height),e.clearColor(0,0,0,1),e.clear(e.COLOR_BUFFER_BIT),e.drawArrays(e.TRIANGLE_STRIP,0,4))}destroy(){const t=this.gl;this.program&&(t.deleteProgram(this.program),this.program=null),this.sourceTexture&&(t.deleteTexture(this.sourceTexture),this.sourceTexture=null)}}class z{provider;renderer;webglRenderer;sourceCanvas;displayCanvas;currentStation=F;currentDirection=null;predictions=[];constructor(){const t=document.getElementById("led-canvas"),e=document.getElementById("led-display");if(!t||!e)throw new Error("Canvas elements not found");this.sourceCanvas=t,this.displayCanvas=e,this.displayCanvas.width=h*S,this.displayCanvas.height=f*S,this.provider=new b,this.renderer=new M(t),this.webglRenderer=new $(e,h,f,{ledSize:.85,glowIntensity:.3,glowRadius:1.5,separationGap:.15}),this.renderer.setAnimationFrameCallback(()=>{this.webglRenderer.render(this.sourceCanvas)})}async initialize(){this.updateStatus("Loading data..."),await Promise.all([this.provider.loadData(),this.renderer.initialize()]),this.populateStationSelector(),this.setupEventListeners(),await this.refresh(),this.startAutoRefresh(),this.updateStatus("Ready")}populateStationSelector(){const t=document.getElementById("station-selector");if(!t)return;const e=this.provider.getStations();e.sort((n,i)=>n.stop_name.localeCompare(i.stop_name)),t.innerHTML="";for(const n of e){const i=document.createElement("option");i.value=n.stop_id,i.textContent=`${n.stop_name} (${n.routes.join(", ")})`,n.stop_id===this.currentStation&&(i.selected=!0),t.appendChild(i)}}setupEventListeners(){const t=document.getElementById("station-selector");t&&t.addEventListener("change",async o=>{this.currentStation=o.target.value,await this.refresh()});const e=document.getElementById("uptown-btn"),n=document.getElementById("downtown-btn"),i=document.getElementById("both-btn");e&&e.addEventListener("click",async()=>{this.currentDirection=0,this.updateDirectionButtons(),await this.refresh()}),n&&n.addEventListener("click",async()=>{this.currentDirection=1,this.updateDirectionButtons(),await this.refresh()}),i&&i.addEventListener("click",async()=>{this.currentDirection=null,this.updateDirectionButtons(),await this.refresh()})}updateDirectionButtons(){const t=document.getElementById("uptown-btn"),e=document.getElementById("downtown-btn"),n=document.getElementById("both-btn");[t,e,n].forEach(i=>{i?.classList.remove("active")}),this.currentDirection===0?t?.classList.add("active"):this.currentDirection===1?e?.classList.add("active"):n?.classList.add("active")}async refresh(){this.predictions=this.provider.getPredictions(this.currentStation,this.currentDirection);const t=[];if(this.predictions.length>0){t.push(this.predictions[0]);const e=this.provider.getSecondTrain(this.predictions);e&&t.push(e)}await this.renderer.render(t),this.webglRenderer.render(this.sourceCanvas),this.updateInfo()}updateInfo(){const t=this.provider.getStation(this.currentStation);if(!t)return;const e=document.getElementById("station-info");if(!e)return;const n=this.getDirectionLabel(t),i=this.predictions.length;e.innerHTML=`
      <strong>${t.stop_name}</strong> - ${t.routes.join(", ")}<br>
      Direction: ${n} | Upcoming trains: ${i}
    `}getDirectionLabel(t){return this.currentDirection===0?t.north_direction_label||"Uptown":this.currentDirection===1?t.south_direction_label||"Downtown":"Both"}updateStatus(t){const e=document.getElementById("status");e&&(e.textContent=t)}startAutoRefresh(){window.setInterval(async()=>{await this.refresh()},_)}}document.addEventListener("DOMContentLoaded",async()=>{const u=new z;try{await u.initialize()}catch(t){console.error("Failed to initialize app:",t);const e=document.getElementById("status");e&&(e.textContent=`Error: ${t}`,e.style.color="red")}});
